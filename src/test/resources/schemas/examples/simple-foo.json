import json
from src import handler
from unittest.mock import patch, MagicMock

def test_lambda_handler_envia_email_com_sucesso():
    # Evento de exemplo simulado
    event = {
        "detail": {
            "pipeline": "lote-diario-churn",
            "status": "SUCESSO",
            "Message": "Pipeline executado com sucesso"
        }
    }

    # Mock do SMTP para n√£o enviar e-mail de verdade
    with patch("smtplib.SMTP") as mock_smtp:
        mock_server = MagicMock()
        mock_smtp.return_value.__enter__.return_value = mock_server

        # Executa a Lambda
        result = handler.lambda_handler(event, None)

        # Verifica se o e-mail foi montado e enviado
        mock_server.send_message.assert_called_once()
        assert result["statusCode"] == 200
        assert json.loads(result["body"]) == "Finalizado com sucesso"
