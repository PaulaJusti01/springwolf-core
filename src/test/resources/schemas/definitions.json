from flask import Flask, Response, request
import json

app = Flask(__name__)

@app.route("/ping", methods=["GET"])
def ping():
    return Response(response="\n", status=200)

@app.route("/invocations", methods=["POST"])
def invocations():
    try:
        # LÃª o JSON da requisiÃ§Ã£o
        data = request.get_json(force=True, silent=True) or {}

        if not data:
            return Response(response="JSON invÃ¡lido ou vazio", status=400)

        # ğŸ”¹ Normaliza formatos possÃ­veis:
        #   - {"instances": [...]}
        #   - {"input-data": {"instances": [...]}}
        #   - {"question": "..."}
        #   - {"data": "..."}
        payload = data

        if "input-data" in data and isinstance(data["input-data"], dict):
            payload = data["input-data"]

        # ğŸ”¹ Trata formato com "instances"
        if isinstance(payload, dict) and "instances" in payload:
            instances = payload["instances"]

            if isinstance(instances, list) and len(instances) > 0:
                instance = instances[0]

                if isinstance(instance, dict):
                    if "question" in instance:
                        msg = instance["question"]
                        return Response(
                            response=f"Pergunta recebida: {msg}", status=200
                        )
                    else:
                        return Response(
                            response=f"Dado recebido: {json.dumps(instance)}",
                            status=200,
                        )
                else:
                    return Response(
                        response="Formato invÃ¡lido em instances", status=400
                    )
            else:
                return Response(
                    response="Lista de instances vazia ou invÃ¡lida", status=400
                )

        # ğŸ”¹ Trata formato simples
        elif "question" in payload:
            return Response(
                response=f"Pergunta recebida: {payload['question']}", status=200
            )

        elif "data" in payload:
            return Response(
                response=f"Dado recebido: {payload['data']}", status=200
            )

        else:
            return Response(response="Entrada invÃ¡lida", status=400)

    except Exception as e:
        print(f"Erro interno: {str(e)}")
        return Response(response=f"Erro interno: {str(e)}", status=500)


if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8080)
