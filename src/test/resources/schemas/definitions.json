from flask import Flask, Response, request
import json
import traceback

app = Flask(__name__)

@app.route("/ping", methods=["GET"])
def ping():
    return Response(response="\n", status=200)

@app.route("/invocations", methods=["POST"])
def invocations():
    try:
        raw_data = request.data.decode("utf-8")
        data = json.loads(raw_data)
        print(f"DEBUG - Dados recebidos: {data}")

        if not data:
            return Response(response="JSON inválido ou vazio", status=400)

        payload = data.get("input-data", data)

        if isinstance(payload, dict) and "instances" in payload:
            instances = payload["instances"]
            if isinstance(instances, list) and len(instances) > 0:
                instance = instances[0]
                if isinstance(instance, dict):
                    msg = instance.get("question", "")
                    return Response(response=f"Pergunta recebida: {msg}", status=200)
                else:
                    return Response(response=f"Instance inválida: {instance}", status=400)
            else:
                return Response(response="Lista de instances vazia ou inválida", status=400)

        elif "question" in payload:
            return Response(response=f"Pergunta recebida: {payload['question']}", status=200)

        elif "data" in payload:
            return Response(response=f"Dado recebido: {payload['data']}", status=200)

        return Response(response=f"Formato inesperado: {payload}", status=400)

    except Exception as e:
        print("ERRO INTERNO NO APP:", traceback.format_exc())
        return Response(response=f"Erro interno: {str(e)}", status=500)

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=8080)
